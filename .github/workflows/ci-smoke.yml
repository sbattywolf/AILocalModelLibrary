name: CI - Smoke & Monitor

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 3 * * *' # daily at 03:00 UTC

jobs:
  smoke:
    name: Run Smoke Tests (Pester)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Pester & run smoke tests
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -Scope CurrentUser -AllowClobber
          Import-Module ./tests/TestHelpers.psm1
          # Run existing smoke tests
          Invoke-Pester -Script tests/Monitor.Background.Smoke.Tests.ps1 -Output Detailed
          # Run schema validation tests to ensure .continue JSON conforms to schemas
          Invoke-Pester -Script tests/Schema.Validation.Tests.ps1 -Output Detailed
          # Validate agent-roles schema samples
          Invoke-Pester -Script tests/AgentRoles.Schema.Tests.ps1 -Output Detailed
          # Run full .continue JSON schema scans
          Invoke-Pester -Script tests/Schema.Validation.All.Tests.ps1 -Output Detailed

      - name: Upload skill-candidates artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: skill-candidates
          path: .continue/skill-candidates.json
          if-no-files-found: warn

  monitor-dryrun:
    name: Monitor DryRun
    needs: smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run dryrun simulator (monitor)
        shell: pwsh
        run: ./scripts/dryrun-simulate.ps1 -ForceCreate

      - name: Upload skill-candidates artifact (post-dryrun)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: skill-candidates
          path: .continue/skill-candidates.json
          if-no-files-found: warn
