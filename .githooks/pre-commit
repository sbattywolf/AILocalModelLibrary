#!/bin/sh
# Run pre-commit secret scan via PowerShell on Windows
REPO_ROOT=$(git rev-parse --show-toplevel)
if command -v powershell.exe >/dev/null 2>&1; then
  # Block accidental commits of repository-private secrets
  staged=$(git diff --cached --name-only)
  for f in $staged; do
    case "$f" in
      .private/*)
        echo "Refusing commit: attempted to add or modify $f under .private/ (private files must not be committed)."
        exit 1
        ;;
    esac
  done

  powershell.exe -NoProfile -ExecutionPolicy Bypass -File "$REPO_ROOT/scripts/pre-commit-scan.ps1"
  rc=$?
  if [ $rc -ne 0 ]; then
    echo "Pre-commit secret scan failed. Commit aborted."
    exit $rc
  fi
  # Run lightweight JSON schema validator to prevent invalid .continue JSON commits
  if [ -f "$REPO_ROOT/scripts/validate-json.py" ]; then
    powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "& '$REPO_ROOT\\scripts\\validate-json.py'"
    rc2=$?
    if [ $rc2 -ne 0 ]; then
      echo "JSON validation failed. Commit aborted."
      exit $rc2
    fi
  fi
fi
exit 0
